// === TSP v2.0 - M√ìDULO MLC (LECTURA CR√çTICA) - FASE 2 COMPLETA ===
// Archivo: js/mlc-module.js

console.log('üìö Inicializando M√≥dulo de Lectura Cr√≠tica TSP v2.0 - FASE 2...');

// === CONFIGURACI√ìN SUPABASE ===
const SUPABASE_CONFIG = {
    url: 'https://kryqjsncqsopjuwymhqd.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyeXFqc25jcXNvcGp1d3ltaHFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjM3MDEsImV4cCI6MjA2ODg5OTcwMX0.w5HiaFiqlFJ_3QbcprUrufsOXTDWFg1zUMl2J7kWD6Y'
};

// Inicializar Supabase si est√° disponible
let supabase = null;
if (typeof window !== 'undefined' && window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
    console.log('‚úÖ Cliente Supabase inicializado');
} else {
    console.warn('‚ö†Ô∏è Librer√≠a Supabase no encontrada, usando modo desarrollo');
}

// === CLASE PRINCIPAL DEL M√ìDULO MLC ===
class MlcModule {
    constructor() {
        this.currentUser = null;
        this.currentLecture = null;
        this.currentStep = 1;
        this.startTime = null;
        this.endTime = null;
        this.timer = null;
        
        // Estados de pasos con sistema de guardas
        this.stepStates = {
            vocabulary: 'pending',      // pending, active, completed
            testVocabulary: 'locked',   // locked, pending, active, completed
            reading: 'locked',          // locked, pending, active, completed
            comprehension: 'locked'     // locked, pending, active, completed
        };
        
        // Variables para vocabulario y test
        this.vocabularyData = null;
        this.vocabularyTestData = null;
        this.vocabularyAnswers = {};
        this.shuffleSeed = null;
        
        console.log('üéØ M√≥dulo MLC inicializado - FASE 2');
    }

    // === INICIALIZACI√ìN ===
    async init() {
        try {
            console.log('üöÄ Iniciando m√≥dulo MLC FASE 2...');
            
            // Cargar usuario de la sesi√≥n
            this.currentUser = this.getUserFromSession();
            
            if (!this.currentUser) {
                console.warn('‚ö†Ô∏è No hay usuario en sesi√≥n');
                this.redirectToDashboard();
                return;
            }

            // Actualizar informaci√≥n del usuario en la interfaz
            this.updateUserInfo();
            
            // Cargar datos de la lectura asignada
            await this.loadAssignedLecture();
            
            // Generar seed para aleatorizaci√≥n consistente
            this.generateShuffleSeed();
            
            // Cargar vocabulario (FASE 2)
            await this.loadVocabulary();
            
            // Inicializar el primer paso
            this.goToStep(1);
            
            // Inicializar timer
            this.initTimer();
            
            console.log('‚úÖ M√≥dulo MLC FASE 2 inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error inicializando m√≥dulo MLC:', error);
            this.showError('Error al cargar el m√≥dulo de lectura cr√≠tica');
        }
    }

    // === GESTI√ìN DE USUARIO ===
    getUserFromSession() {
        // Intentar obtener datos del usuario desde sessionStorage
        const userData = sessionStorage.getItem('tsp_user');
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }
        
        // Datos de prueba para desarrollo
        console.log('üß™ Usando datos de prueba para desarrollo');
        return {
            id: 'user123',
            codigo_estudiante: 'E001002',
            nombres: 'Juan Carlos',
            apellidos: 'P√©rez Gonz√°lez',
            grado: 5
        };
    }

    updateUserInfo() {
        const studentNameEl = document.getElementById('studentName');
        if (studentNameEl && this.currentUser) {
            studentNameEl.textContent = `${this.currentUser.nombres} ${this.currentUser.apellidos}`;
        }
    }

    // === SEED PARA ALEATORIZACI√ìN CONSISTENTE ===
    generateShuffleSeed() {
        // Seed basado en estudiante_id + fecha del d√≠a para reproducibilidad pero no copia entre estudiantes
        const today = new Date().toDateString();
        const seedString = `${this.currentUser.id}_${today}`;
        this.shuffleSeed = this.simpleHash(seedString);
        console.log('üé≤ Seed de aleatorizaci√≥n generado:', this.shuffleSeed);
    }

    simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return Math.abs(hash);
    }

    // === CARGA DE DATOS ===
    async loadAssignedLecture() {
        console.log('üìñ Cargando lectura asignada...');
        
        try {
            if (supabase) {
                // Intentar cargar desde Supabase
                const { data, error } = await supabase
                    .from('lecturas')
                    .select('*')
                    .eq('activo', true)
                    .gte('grado_minimo', this.currentUser.grado - 1)
                    .lte('grado_maximo', this.currentUser.grado + 1)
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    this.currentLecture = data[0];
                    console.log('‚úÖ Lectura cargada desde Supabase:', this.currentLecture.titulo);
                    return;
                }
            }
            
            // Fallback: datos de ejemplo para FASE 2
            this.currentLecture = {
                id: 'lectura-ejemplo-fase2',
                titulo: 'El Coyote y la Tortuga',
                autor: 'Leyenda Hopi',
                palabras: 107,
                grado_minimo: 3,
                grado_maximo: 5,
                vocabulario: {
                    items: [
                        {
                            indice: 1,
                            termino: 'enojamos',
                            definicion: 'Cuando alguien se siente molesto o furioso por algo.',
                            pregunta: '¬øQu√© significa "enojamos" en el texto?',
                            opciones: {
                                A: 'Nos re√≠mos mucho.',
                                B: 'Nos sentimos felices.',
                                C: 'Nos molestamos o sentimos rabia.',
                                D: 'Nos cansamos de esperar.'
                            },
                            respuesta_correcta: 'C'
                        },
                        {
                            indice: 2,
                            termino: 'r√≠o',
                            definicion: 'Corriente de agua que fluye hacia el mar.',
                            pregunta: '¬øQu√© es un r√≠o seg√∫n el texto?',
                            opciones: {
                                A: 'Una monta√±a muy alta',
                                B: 'Corriente de agua que fluye hacia el mar',
                                C: 'Un animal que nada',
                                D: 'Una planta acu√°tica'
                            },
                            respuesta_correcta: 'B'
                        },
                        {
                            indice: 3,
                            termino: 'tortuga',
                            definicion: 'Animal con caparaz√≥n que se mueve lentamente.',
                            pregunta: '¬øC√≥mo es una tortuga?',
                            opciones: {
                                A: 'Animal con caparaz√≥n que se mueve lentamente',
                                B: 'Animal que vuela muy r√°pido',
                                C: 'Planta que crece en el agua',
                                D: 'Piedra que rueda por el r√≠o'
                            },
                            respuesta_correcta: 'A'
                        },
                        {
                            indice: 4,
                            termino: 'coyote',
                            definicion: 'Animal carn√≠voro parecido al lobo pero m√°s peque√±o.',
                            pregunta: '¬øQu√© tipo de animal es el coyote?',
                            opciones: {
                                A: 'Un pez de r√≠o',
                                B: 'Animal carn√≠voro parecido al lobo pero m√°s peque√±o',
                                C: 'Un insecto volador',
                                D: 'Una planta del desierto'
                            },
                            respuesta_correcta: 'B'
                        },
                        {
                            indice: 5,
                            termino: 'r√°pido',
                            definicion: 'Que se mueve o act√∫a con mucha velocidad.',
                            pregunta: '¬øQu√© significa ser r√°pido?',
                            opciones: {
                                A: 'Moverse muy lentamente',
                                B: 'Estar siempre quieto',
                                C: 'Que se mueve o act√∫a con mucha velocidad',
                                D: 'Dormir mucho tiempo'
                            },
                            respuesta_correcta: 'C'
                        },
                        {
                            indice: 6,
                            termino: 'lento',
                            definicion: 'Que se mueve o act√∫a sin prisa, despacio.',
                            pregunta: '¬øC√≥mo se mueve algo lento?',
                            opciones: {
                                A: 'Con mucha velocidad',
                                B: 'Que se mueve o act√∫a sin prisa, despacio',
                                C: 'Saltando muy alto',
                                D: 'Gritando fuerte'
                            },
                            respuesta_correcta: 'B'
                        },
                        {
                            indice: 7,
                            termino: 'carrera',
                            definicion: 'Competencia para ver qui√©n llega primero.',
                            pregunta: '¬øQu√© es una carrera?',
                            opciones: {
                                A: 'Una comida deliciosa',
                                B: 'Competencia para ver qui√©n llega primero',
                                C: 'Un lugar para dormir',
                                D: 'Una herramienta de trabajo'
                            },
                            respuesta_correcta: 'B'
                        },
                        {
                            indice: 8,
                            termino: 'ganar',
                            definicion: 'Obtener la victoria en una competencia.',
                            pregunta: '¬øQu√© significa ganar?',
                            opciones: {
                                A: 'Perder siempre',
                                B: 'Estar triste',
                                C: 'Obtener la victoria en una competencia',
                                D: 'Correr hacia atr√°s'
                            },
                            respuesta_correcta: 'C'
                        },
                        {
                            indice: 9,
                            termino: 'orgulloso',
                            definicion: 'Que siente mucha satisfacci√≥n por algo propio.',
                            pregunta: '¬øC√≥mo se siente alguien orgulloso?',
                            opciones: {
                                A: 'Muy triste y deprimido',
                                B: 'Que siente mucha satisfacci√≥n por algo propio',
                                C: 'Con mucho miedo',
                                D: 'Muy confundido'
                            },
                            respuesta_correcta: 'B'
                        },
                        {
                            indice: 10,
                            termino: 'burlar',
                            definicion: 'Re√≠rse de alguien de manera cruel.',
                            pregunta: '¬øQu√© significa burlar?',
                            opciones: {
                                A: 'Ayudar con cari√±o',
                                B: 'Re√≠rse de alguien de manera cruel',
                                C: 'Dar un regalo bonito',
                                D: 'Cantar una canci√≥n'
                            },
                            respuesta_correcta: 'B'
                        }
                    ]
                },
                preguntas_tc: {
                    preguntas: [
                        {
                            indice: 1,
                            pregunta: '¬øPor qu√© el coyote arroj√≥ a la tortuga al r√≠o?',
                            opciones: {
                                A: 'Porque quer√≠a verla nadar.',
                                B: 'Porque la tortuga lo ayud√≥.',
                                C: 'Porque estaba enojado con ella.',
                                D: 'Porque ten√≠a miedo del r√≠o.'
                            },
                            respuesta_correcta: 'C',
                            orientacion: 'Busca en el texto c√≥mo se sent√≠a el coyote con la tortuga despu√©s de perder la carrera.',
                            retroalimentacion: 'La opci√≥n correcta es C porque el texto dice que el coyote estaba muy enojado despu√©s de que la tortuga ganara la carrera.'
                        }
                    ]
                }
            };
            
            console.log('üß™ Usando lectura de ejemplo para FASE 2');
            
        } catch (error) {
            console.error('‚ùå Error cargando lectura:', error);
            this.showError('Error al cargar la lectura asignada');
        }
    }

    // === FASE 2: VOCABULARIO ===
    async loadVocabulary() {
        console.log('üìö Cargando vocabulario FASE 2...');
        
        try {
            if (!this.currentLecture || !this.currentLecture.vocabulario) {
                throw new Error('No hay vocabulario disponible');
            }

            this.vocabularyData = this.currentLecture.vocabulario.items;
            
            // Mostrar vocabulario en la interfaz
            await this.renderVocabulary();
            
            // Preparar test de vocabulario
            this.prepareVocabularyTest();
            
            // Habilitar bot√≥n de continuar
            this.enableContinueToTest();
            
            console.log('‚úÖ Vocabulario cargado - 10 t√©rminos disponibles');
            
        } catch (error) {
            console.error('‚ùå Error cargando vocabulario:', error);
            this.showError('Error al cargar el vocabulario');
        }
    }

    async renderVocabulary() {
    const container = document.getElementById('vocabularyContent');
    
    if (!this.vocabularyData || this.vocabularyData.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--error-600);">No hay vocabulario disponible</p>';
        return;
    }

    // Crear HTML para cada t√©rmino
    const vocabularyHTML = this.vocabularyData.map(item => `
        <div class="vocabulary-item">
            <div class="term-number">${item.indice}</div>
            <div class="term-content">
                <h4>${item.termino}</h4>
                <p class="term-definition">${item.definicion}</p>
            </div>
        </div>
    `).join('');

    container.innerHTML = vocabularyHTML;
    
    // ‚úÖ CORRECCI√ìN: Marcar paso como completado con log claro
    console.log('üìö Marcando vocabulario como completado...');
    this.stepStates.vocabulary = 'completed';
    this.stepStates.testVocabulary = 'pending';
    
    console.log('üìä Estados actuales:', this.stepStates);
    console.log('‚úÖ Vocabulario renderizado y marcado como completado');
}

logCurrentStates() {
    console.log('üîç ESTADO ACTUAL DE PASOS:');
    console.log('- Vocabulario:', this.stepStates.vocabulary);
    console.log('- Test Vocabulario:', this.stepStates.testVocabulary);
    console.log('- Lectura:', this.stepStates.reading);
    console.log('- Comprensi√≥n:', this.stepStates.comprehension);
}

    enableContinueToTest() {
        const btn = document.getElementById('continueToTestBtn');
        if (btn) {
            btn.disabled = false;
            btn.style.opacity = '1';
            console.log('‚úÖ Bot√≥n "Continuar al Test" habilitado');
        } else {
            console.warn('‚ö†Ô∏è Bot√≥n continueToTestBtn no encontrado');
        }
    }

    // === FASE 2: TEST DE VOCABULARIO ===
    prepareVocabularyTest() {
        console.log('üìù Preparando test de vocabulario...');
        
        // Crear datos del test con opciones aleatorizadas
        this.vocabularyTestData = this.vocabularyData.map(item => {
            // Aleatorizar opciones usando el seed
            const shuffledOptions = this.shuffleOptionsWithSeed(item.opciones, this.shuffleSeed + item.indice);
            
            return {
                ...item,
                shuffledOptions: shuffledOptions,
                correctAnswerAfterShuffle: this.findCorrectAfterShuffle(item.opciones, item.respuesta_correcta, shuffledOptions)
            };
        });
        
        console.log('‚úÖ Test de vocabulario preparado con opciones aleatorizadas');
    }

    shuffleOptionsWithSeed(opciones, seed) {
        // Convertir opciones a array para mezclar
        const letters = ['A', 'B', 'C', 'D'];
        const optionsArray = letters.map(letter => ({
            letter: letter,
            text: opciones[letter]
        }));
        
        // Shuffle usando seed
        for (let i = optionsArray.length - 1; i > 0; i--) {
            const j = Math.floor(this.seededRandom(seed + i) * (i + 1));
            [optionsArray[i], optionsArray[j]] = [optionsArray[j], optionsArray[i]];
        }
        
        // Convertir de vuelta a objeto con nuevas letras
        const shuffled = {};
        optionsArray.forEach((option, index) => {
            shuffled[letters[index]] = option.text;
        });
        
        return shuffled;
    }

    findCorrectAfterShuffle(originalOptions, originalCorrect, shuffledOptions) {
        const correctText = originalOptions[originalCorrect];
        
        // Encontrar en qu√© letra qued√≥ despu√©s del shuffle
        for (const letter of ['A', 'B', 'C', 'D']) {
            if (shuffledOptions[letter] === correctText) {
                return letter;
            }
        }
        
        return 'A'; // Fallback
    }

    seededRandom(seed) {
        const x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }

    loadVocabularyTest() {
        console.log('üìù Cargando test de vocabulario...');
        
        const container = document.getElementById('vocabularyTestContent');
        
        if (!this.vocabularyTestData) {
            container.innerHTML = '<p style="text-align: center; color: var(--error-600);">Error cargando el test</p>';
            return;
        }

        // Crear HTML para cada pregunta
        const questionsHTML = this.vocabularyTestData.map(item => `
            <div class="question-item" data-question-id="${item.indice}">
                <div class="question-header">
                    <span class="question-number">Pregunta ${item.indice}</span>
                </div>
                <div class="question-text">
                    ${item.pregunta}
                </div>
                <div class="question-options">
                    ${Object.entries(item.shuffledOptions).map(([letter, text]) => `
                        <label class="option-label" data-letter="${letter}">
                            <input type="radio" name="question_${item.indice}" value="${letter}" 
                                   onchange="selectVocabularyAnswer(${item.indice}, '${letter}')">
                            <span class="option-text">${letter}. ${text}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');

        container.innerHTML = questionsHTML;
        
        console.log('‚úÖ Test de vocabulario cargado con opciones aleatorizadas');
    }

    selectVocabularyAnswer(questionId, answer) {
        console.log(`üìù Respuesta seleccionada - Pregunta ${questionId}: ${answer}`);
        
        this.vocabularyAnswers[questionId] = answer;
        
        // Marcar visualmente la pregunta como respondida
        const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
        if (questionItem) {
            questionItem.classList.add('answered');
        }
        
        // Marcar opci√≥n como seleccionada
        const options = document.querySelectorAll(`input[name="question_${questionId}"]`);
        options.forEach(option => {
            const label = option.closest('.option-label');
            label.classList.toggle('selected', option.checked);
        });
        
        // Verificar si se pueden habilitar los botones
        this.checkTestProgress();
    }

    checkTestProgress() {
        const totalQuestions = this.vocabularyTestData.length;
        const answeredQuestions = Object.keys(this.vocabularyAnswers).length;
        
        console.log(`üìä Progreso del test: ${answeredQuestions}/${totalQuestions}`);
        
        // Habilitar bot√≥n de enviar si todas las preguntas est√°n respondidas
        const submitBtn = document.getElementById('submitTestBtn');
        if (submitBtn) {
            submitBtn.disabled = answeredQuestions < totalQuestions;
            submitBtn.style.opacity = answeredQuestions < totalQuestions ? '0.6' : '1';
        }
    }

    async submitVocabularyTest() {
        console.log('üìù Enviando test de vocabulario...');
        
        try {
            // Calcular resultados
            const results = this.calculateVocabularyResults();
            
            // Mostrar resultados
            this.showVocabularyResults(results);
            
            // Verificar si puede continuar al siguiente paso
            if (results.score === 10) {
                this.stepStates.testVocabulary = 'completed';
                this.stepStates.reading = 'pending';
                this.enableContinueToReading();
                console.log('‚úÖ Test aprobado 10/10 - Lectura desbloqueada');
            } else {
                console.log(`‚ùå Test no aprobado ${results.score}/10 - Lectura sigue bloqueada`);
                this.showRetryOption();
            }
            
        } catch (error) {
            console.error('‚ùå Error enviando test:', error);
            this.showError('Error al procesar las respuestas');
        }
    }

    calculateVocabularyResults() {
        let correctAnswers = 0;
        const details = [];
        
        this.vocabularyTestData.forEach(item => {
            const userAnswer = this.vocabularyAnswers[item.indice];
            const isCorrect = userAnswer === item.correctAnswerAfterShuffle;
            
            if (isCorrect) correctAnswers++;
            
            details.push({
                question: item.indice,
                userAnswer: userAnswer,
                correctAnswer: item.correctAnswerAfterShuffle,
                isCorrect: isCorrect,
                term: item.termino
            });
        });
        
        return {
            score: correctAnswers,
            total: this.vocabularyTestData.length,
            percentage: (correctAnswers / this.vocabularyTestData.length) * 100,
            details: details
        };
    }

    showVocabularyResults(results) {
        const resultsContainer = document.getElementById('testResults');
        
        const isSuccess = results.score === 10;
        const resultClass = isSuccess ? 'success' : 'error';
        const resultMessage = isSuccess 
            ? '¬°Perfecto! Has completado el vocabulario correctamente.' 
            : `Necesitas 10/10 para continuar. Obtuviste ${results.score}/10.`;
        
        resultsContainer.innerHTML = `
            <div class="result-score ${resultClass}">
                ${results.score}/10
            </div>
            <div class="result-message">
                ${resultMessage}
            </div>
            <div class="result-details">
                ${isSuccess 
                    ? 'Ahora puedes continuar a la lectura del texto.' 
                    : 'Revisa los t√©rminos y vuelve a intentarlo.'
                }
            </div>
        `;
        
        resultsContainer.style.display = 'block';
        resultsContainer.className = `test-results ${resultClass}`;
        
        // Ocultar bot√≥n de enviar
        const submitBtn = document.getElementById('submitTestBtn');
        if (submitBtn) {
            submitBtn.style.display = 'none';
        }
    }

    enableContinueToReading() {
        const btn = document.getElementById('continueToReadingBtn');
        if (btn) {
            btn.style.display = 'inline-flex';
            btn.disabled = false;
        }
    }

    showRetryOption() {
        // Agregar bot√≥n de reintentar
        const actions = document.querySelector('#testVocabularySection .step-actions');
        
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn btn-warning';
        retryBtn.onclick = () => this.retryVocabularyTest();
        retryBtn.innerHTML = 'üîÑ Intentar de Nuevo';
        
        actions.appendChild(retryBtn);
    }

    retryVocabularyTest() {
        console.log('üîÑ Reintentando test de vocabulario...');
        
        // Limpiar respuestas
        this.vocabularyAnswers = {};
        
        // Generar nuevo seed para diferentes opciones
        this.shuffleSeed = this.shuffleSeed + 1000;
        
        // Preparar nuevo test
        this.prepareVocabularyTest();
        this.loadVocabularyTest();
        
        // Ocultar resultados
        const resultsContainer = document.getElementById('testResults');
        resultsContainer.style.display = 'none';
        
        // Restaurar bot√≥n de enviar
        const submitBtn = document.getElementById('submitTestBtn');
        if (submitBtn) {
            submitBtn.style.display = 'inline-flex';
            submitBtn.disabled = true;
        }
        
        // Ocultar bot√≥n de continuar y quitar retry
        const continueBtn = document.getElementById('continueToReadingBtn');
        if (continueBtn) {
            continueBtn.style.display = 'none';
        }
        
        // Remover bot√≥n de retry
        const retryBtn = document.querySelector('.btn-warning');
        if (retryBtn) {
            retryBtn.remove();
        }
    }

    // === NAVEGACI√ìN ENTRE PASOS CON GUARDAS ===
    goToStep(stepNumber) {
        console.log(`üìç Navegando al paso ${stepNumber}`);
        
        // Validar rango de pasos
        if (stepNumber < 1 || stepNumber > 4) {
            console.error('‚ùå N√∫mero de paso inv√°lido:', stepNumber);
            return;
        }

        // Verificar guardas antes de permitir navegaci√≥n
        if (!this.canAccessStep(stepNumber)) {
            console.warn(`üö´ Acceso denegado al paso ${stepNumber}`);
            this.showAccessDeniedMessage(stepNumber);
            return;
        }

        // Actualizar paso actual
        this.currentStep = stepNumber;
        
        // Ocultar todas las secciones
        const sections = document.querySelectorAll('.step-section');
        sections.forEach(section => {
            section.classList.remove('active');
        });
        
        // Mostrar la secci√≥n correspondiente
        const sectionIds = [
            '',
            'vocabularySection',
            'testVocabularySection', 
            'readingSection',
            'comprehensionSection'
        ];
        
        const targetSection = document.getElementById(sectionIds[stepNumber]);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Actualizar barra de progreso
        this.updateProgress();
        
        // Ejecutar acciones espec√≠ficas del paso
        this.executeStepActions(stepNumber);
    }

    canAccessStep(stepNumber) {
    console.log(`üîç Verificando acceso al paso ${stepNumber}...`);
    this.logCurrentStates();
    
    let canAccess = false;
    
    switch(stepNumber) {
        case 1:
            canAccess = true; // Siempre accesible
            break;
        case 2:
            canAccess = this.stepStates.vocabulary === 'completed';
            console.log(`üìù Paso 2 - Vocabulario completado? ${canAccess}`);
            break;
        case 3:
            canAccess = this.stepStates.testVocabulary === 'completed';
            console.log(`üìñ Paso 3 - Test completado? ${canAccess}`);
            break;
        case 4:
            canAccess = this.stepStates.reading === 'completed';
            console.log(`üß† Paso 4 - Lectura completada? ${canAccess}`);
            break;
        default:
            canAccess = false;
    }
    
    console.log(`${canAccess ? '‚úÖ' : '‚ùå'} Acceso al paso ${stepNumber}: ${canAccess ? 'PERMITIDO' : 'DENEGADO'}`);
    return canAccess;
}

    showAccessDeniedMessage(stepNumber) {
        const stepNames = ['', 'Vocabulario', 'Test de Vocabulario', 'Lectura', 'Comprensi√≥n'];
        alert(`‚ö†Ô∏è Debes completar el paso anterior antes de acceder a "${stepNames[stepNumber]}"`);
    }

    executeStepActions(stepNumber) {
    switch(stepNumber) {
        case 1:
            console.log('üìñ Activando estudio de vocabulario');
            // ‚úÖ CORRECCI√ìN: No sobrescribir si ya est√° completado
            if (this.stepStates.vocabulary !== 'completed') {
                this.stepStates.vocabulary = 'active';
            }
            break;
        case 2:
            console.log('üìù Activando test de vocabulario');
            // ‚úÖ CORRECCI√ìN: No sobrescribir si ya est√° completado
            if (this.stepStates.testVocabulary !== 'completed') {
                this.stepStates.testVocabulary = 'active';
            }
            this.loadVocabularyTest();
            break;
        case 3:
            console.log('‚è±Ô∏è Activando lectura con cron√≥metro');
            if (this.stepStates.reading !== 'completed') {
                this.stepStates.reading = 'active';
            }
            this.startTimer();
            break;
        case 4:
            console.log('üß† Activando test de comprensi√≥n');
            if (this.stepStates.comprehension !== 'completed') {
                this.stepStates.comprehension = 'active';
            }
            this.stopTimer();
            break;
    }
    
    this.updateStepIndicators();
}

    // === ACTUALIZACI√ìN DE INTERFAZ ===
    updateProgress() {
        const progressFill = document.getElementById('progressFill');
        if (progressFill) {
            const percentage = (this.currentStep / 4) * 100;
            progressFill.style.width = `${percentage}%`;
        }
    }

    updateStepIndicators() {
        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById(`step${i}Progress`);
            if (stepEl) {
                stepEl.classList.remove('active', 'completed');
                
                if (i < this.currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === this.currentStep) {
                    stepEl.classList.add('active');
                }
            }
        }
    }

    // === CRON√ìMETRO ===
    initTimer() {
        this.startTime = null;
        this.endTime = null;
        this.updateTimerDisplay('00:00:00');
    }

    startTimer() {
        if (!this.startTime) {
            this.startTime = Date.now();
            console.log('‚è±Ô∏è Cron√≥metro iniciado');
            
            this.timer = setInterval(() => {
                this.updateTimerDisplay();
            }, 1000);
        }
    }

    stopTimer() {
        if (this.timer) {
            clearInterval(this.timer);
            this.endTime = Date.now();
            console.log('‚èπÔ∏è Cron√≥metro detenido');
            
            const elapsedMs = this.endTime - this.startTime;
            console.log(`üìä Tiempo de lectura: ${elapsedMs}ms`);
        }
    }

    updateTimerDisplay(timeString = null) {
        const timerEl = document.getElementById('timerDisplay');
        if (timerEl) {
            if (timeString) {
                timerEl.textContent = timeString;
            } else if (this.startTime) {
                const elapsedMs = Date.now() - this.startTime;
                const formatted = this.formatTime(elapsedMs);
                timerEl.textContent = formatted;
            }
        }
    }

    formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // === FINALIZACI√ìN ===
    finishMLC() {
        console.log('üéâ Finalizando m√≥dulo MLC...');
        
        // Calcular m√©tricas b√°sicas
        const elapsedMs = this.endTime - this.startTime;
        const words = this.currentLecture ? this.currentLecture.palabras : 107;
        const wpm = words > 0 ? (words * 60000) / elapsedMs : 0;
        
        console.log('üìä M√©tricas calculadas:');
        console.log(`- Tiempo: ${elapsedMs}ms`);
        console.log(`- Palabras: ${words}`);
        console.log(`- WPM: ${wpm.toFixed(1)}`);
        
        // Mostrar mensaje de finalizaci√≥n
        alert(`üéâ ¬°M√≥dulo MLC FASE 2 completado!\n\nüìö Vocabulario: ‚úÖ Completado\nüìù Test: ‚úÖ 10/10\n‚è±Ô∏è Tiempo de lectura: ${this.formatTime(elapsedMs)}\nüìà Velocidad: ${wpm.toFixed(1)} WPM\n\n(FASE 3 y 4 pr√≥ximamente)`);
        
        // Regresar al dashboard
        this.redirectToDashboard();
    }

    // === NAVEGACI√ìN ===
    redirectToDashboard() {
        console.log('üîÑ Redirigiendo al dashboard...');
        window.location.href = 'dashboard-estudiante.html';
    }

    // === UTILIDADES ===
    showError(message) {
        console.error('‚ùå', message);
        alert(`Error: ${message}`);
    }

    showSuccess(message) {
        console.log('‚úÖ', message);
    }

    formatDate(date) {
        return new Date(date).toLocaleDateString('es-CO', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            timeZone: 'America/Bogota'
        });
    }
}

// === FUNCIONES GLOBALES ===

// Instancia global del m√≥dulo
let mlcModule = null;

// Funci√≥n para ir a un paso espec√≠fico
function goToStep(stepNumber) {
    if (mlcModule) {
        mlcModule.goToStep(stepNumber);
    } else {
        console.error('‚ùå M√≥dulo MLC no inicializado');
    }
}

// Funci√≥n para seleccionar respuesta de vocabulario
function selectVocabularyAnswer(questionId, answer) {
    if (mlcModule) {
        mlcModule.selectVocabularyAnswer(questionId, answer);
    } else {
        console.error('‚ùå M√≥dulo MLC no inicializado');
    }
}

// Funci√≥n para enviar test de vocabulario
function submitVocabularyTest() {
    if (mlcModule) {
        mlcModule.submitVocabularyTest();
    } else {
        console.error('‚ùå M√≥dulo MLC no inicializado');
    }
}

// Funci√≥n para finalizar el m√≥dulo
function finishMLC() {
    if (mlcModule) {
        mlcModule.finishMLC();
    } else {
        console.error('‚ùå M√≥dulo MLC no inicializado');
    }
}

// === INICIALIZACI√ìN AUTOM√ÅTICA ===
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üéì DOM cargado, inicializando m√≥dulo MLC FASE 2...');
    
    try {
        mlcModule = new MlcModule();
        await mlcModule.init();
    } catch (error) {
        console.error('‚ùå Error fatal inicializando m√≥dulo MLC:', error);
        alert('Error al cargar el m√≥dulo. Por favor, intenta nuevamente.');
        
        // Redirigir al dashboard en caso de error cr√≠tico
        setTimeout(() => {
            window.location.href = 'dashboard-estudiante.html';
        }, 2000);
    }
});

// === MANEJO DE ERRORES GLOBALES ===
window.addEventListener('error', function(event) {
    console.error('‚ùå Error global capturado:', event.error);
});

console.log('üìö M√≥dulo MLC FASE 2 cargado exitosamente');

// === EXPORTAR PARA DEBUGGING ===
if (typeof window !== 'undefined') {
    window.mlcModule = mlcModule;
    window.goToStep = goToStep;
    window.selectVocabularyAnswer = selectVocabularyAnswer;
    window.submitVocabularyTest = submitVocabularyTest;
    window.finishMLC = finishMLC;
}